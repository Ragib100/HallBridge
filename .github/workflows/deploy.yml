name: Deploy HallBridge Email Server

on:
  workflow_dispatch:       # manual trigger
  push:
    branches:
      - main
  pull_request:
    types: [closed]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: SSH to VM and deploy
        run: |
          ssh ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
            # Load NVM
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            echo "ðŸš€ Starting deployment..."

            BASE_DIR=~/HallBridge
            APP_DIR=$BASE_DIR/email-server

            # Pull latest code
            cd $BASE_DIR
            echo "ðŸ“ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            # Install dependencies
            cd $APP_DIR
            echo "ðŸ“¦ Installing dependencies..."
            export NODE_OPTIONS="--max-old-space-size=512"
            pnpm install --frozen-lockfile

            # Restart PM2 process
            echo "ðŸ”„ Restarting PM2..."
            pm2 reload HallBridge || pm2 start email_server.js --name HallBridge
            pm2 save

            echo "âœ… Deployment complete!"
          EOF
